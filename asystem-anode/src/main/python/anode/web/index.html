<!DOCTYPE html>
<html>
<head>
    <title>anode</title>
    <link rel="apple-touch-icon" sizes="57x57" href="ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <link rel="manifest" href="ico/manifest.json">
    <link rel="stylesheet" type="text/css" href="css/anode.css">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-title" content="ANode">
    <script type="text/javascript" src="js/moment/moment.js"></script>
    <script type="text/javascript" src="js/anode.js"></script>
    <script type="text/javascript">
        window.onpageshow = function (event) {
            if (event.persisted) {
                window.location.reload()
            }
        };
        var datumsLast = []
        var datumsTimer = {};
        var anode = new ANode(document.location.href,
            function () {
                document.getElementById('datums_header_timeliness').innerHTML = "<a href=\"" + document.location.href + "\">connected</a>";
                document.getElementById('datums_header_timeliness').className = "datum-detail up";
            },
            function () {
                document.getElementById('datums_header_timeliness').innerHTML = "<a href=\"" + document.location.href + "\">disconnected</a>";
                document.getElementById('datums_header_timeliness').className = "datum-detail down";
            },
            function (datum) {
                if (document.location.href.indexOf("anode", this.length - "anode".length) > 0 ||
                    datum.data_metric.indexOf("anode", this.length - "anode".length) == -1) {
                    document.getElementById('datums_header_metric').innerHTML = "<a href=\"/?metrics=anode\">anode" + "</a>.<a href=\"/\">" + datum.anode_id + "</a>";
                    var datumDiv = document.getElementById(datum.ui_id);
                    if (datumDiv == null && datum.data_type !== "high" && datum.data_type !== "low") {
                        datumDiv = document.createElement('div');
                        datumDiv.id = datum.ui_id;
                        datumDiv.className = "datum";
                        var datumGroupsFields = {
                            "header": {
                                "metric": (function (metric) {
                                    var i;
                                    var metricLinks = "";
                                    var metricTokens = metric.split("\.");
                                    for (i = 0; i < metricTokens.length; i++) {
                                        metricLinks += (i == 0 ? "" : ".") + "<a href=\"/?metrics=" + metricTokens[i] + "\">" + metricTokens[i] + "</a>"
                                    }
                                    return metricLinks
                                })(datum.data_metric),
                                "timeliness": datum.data_timeliness
                            },
                            "detail": {
                                "value": "",
                                "unit": (datum.data_unit == "scalor" || datum.data_type == "enumeration") ? null : datum.data_unit,
                                "trend": "",
                                "low": "",
                                "high": "",
                            }
                        };
                        for (var datumGroup in datumGroupsFields) {
                            var datumGroupDiv = document.createElement('div');
                            datumGroupDiv.className = "datum";
                            for (var datumField in datumGroupsFields[datumGroup]) {
                                (function (datumField) {
                                    if (datumGroupsFields[datumGroup][datumField] != null) {
                                        var datumFieldDiv = document.createElement('div');
                                        datumFieldDiv.id = ((datumField == "low" || datumField == "high") ?
                                                (datum.ui_id_sans_bin + (datum.data_temporal == "forecast" ?
                                                    (datum.bin_width + "_" + datum.bin_unit) : "1_day")) : datum.ui_id) + "_" + datumField;
                                        datumFieldDiv.className = "datum-detail";
                                        datumFieldDiv.innerHTML = datumGroupsFields[datumGroup][datumField];
                                        datumGroupDiv.appendChild(datumFieldDiv);
                                    }
                                })(datumField);
                            }
                            datumDiv.appendChild(datumGroupDiv);
                        }
                        datumDiv.appendChild(document.createElement('hr'));
                        var index = 0;
                        for (index = 0; index < datumsLast.length; index++) {
                            if (datumsLast[index].order_index > datum.order_index) {
                                break;
                            }
                        }
                        datumsLast.splice(index, 0, datum);
                        document.getElementById('datums').insertBefore(datumDiv, document.getElementById('datums').childNodes[index]);
                    }
                    var datumValueId = datum.ui_id + "_" + ((datum.data_type == "high" || datum.data_type == "low") ? datum.data_type : "value");
                    if (document.getElementById(datumValueId) != null) {
                        var datumValueDelta = parseFloat(
                            document.getElementById(datumValueId).innerHTML.trim().length == 0 ? 0 :
                                (datum.data_type == "high" ? 1 : (datum.data_type == "low" ? -1 :
                                        (datum.data_value / datum.data_scale - document.getElementById(datumValueId).innerHTML))).toFixed(2));
                        var datumGroupsValues = {
                            "value": {
                                "id": datumValueId,
                                "value": datum.data_type == "enumeration" ? datum.data_unit : (datum.data_type == "epoch" ?
                                        moment(new Date(datum.data_value * 1000)).format('HH:mm:ss MMMM Do YYYY').toLowerCase() : datum.data_value / datum.data_scale),
                                "value_delta": datumValueDelta,
                                "value_prefix": (datum.data_type == "high" ? "&#8613;" : (datum.data_type == "low" ? "&#8615;" : ""))
                            },
                            "unit": {
                                "id": datum.ui_id + "_unit",
                                "value": ((datum.data_type == "high" || datum.data_type == "low" || datum.data_type == "enumeration") ? null : datum["data_unit"]),
                                "value_delta": datumValueDelta,
                                "value_prefix": ""
                            },
                            "trend": {
                                "id": datum.ui_id + "_trend",
                                "value": (
                                    (datum.data_type == "high" || datum.data_type == "low" || datum.data_type == "epoch" || datum.data_type == "enumeration") ?
                                        null : datumValueDelta),
                                "value_delta": datumValueDelta,
                                "value_prefix": datumValueDelta >= 0 ? "+" : ""
                            }
                        };
                        for (var datumGroup in datumGroupsValues) {
                            for (var datumValue in datumGroupsValues[datumGroup]) {
                                (function (datumDetailId, datumDetailValue, datumDetailValueDelta, datumDetailValuePrefix) {
                                    if (datumDetailValue !== null) {
                                        var datumDetailDiv = document.getElementById(datumDetailId);
                                        if (datumDetailDiv !== null) {
                                            var datumDetailValueClass = datumDetailDiv.className;
                                            if (datumDetailValueDelta > 0) {
                                                datumDetailValueClass = "datum-detail up";
                                            }
                                            else if (datumDetailValueDelta < 0) {
                                                datumDetailValueClass = "datum-detail down";
                                            }
                                            datumDetailDiv.innerHTML = datumDetailValuePrefix + datumDetailValue;
                                            datumDetailDiv.className = datumDetailValueClass;
                                            if (datumDetailId in datumsTimer) {
                                                window.clearTimeout(datumsTimer[datumDetailId]);
                                            }
                                            datumsTimer[datumDetailId] = window.setTimeout(function () {
                                                datumDetailDiv.className = "datum-detail";
                                            }, 5000);
                                        }
                                    }
                                })(datumGroupsValues[datumGroup]["id"], datumGroupsValues[datumGroup]["value"],
                                    datumGroupsValues[datumGroup]["value_delta"], datumGroupsValues[datumGroup]["value_prefix"])
                            }
                        }
                    }
                }
            });
    </script>
</head>
<body>
<div>
    <!-- @formatter:off --><!-- @formatter:on -->

    <div class="datums">
        <div class="datum">
            <div class="datum">
                <div id="datums_header_metric" class="datum-detail">anode</div>
                <div id="datums_header_timeliness" class="datum-detail">
                    <a href="javascript:window.location.href=window.location.href">connecting ...</a>
                </div>
                <div class="datum-detail">
                    <a href="/?metrics=power">power</a>
                </div>
                <div class="datum-detail">
                    <a href="/?metrics=temperature&bins=1day&bins=50s&bins=2s">temperature</a>
                </div>
            </div>
            <hr/>
        </div>
    </div>
    <div id="datums" class="datums">
    </div>

</div>
</body>
</html>