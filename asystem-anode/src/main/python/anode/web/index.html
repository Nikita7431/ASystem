<!DOCTYPE html>
<html>
<head>
    <title>anode</title>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="57x57" href="ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <link rel="manifest" href="ico/manifest.json">
    <link rel="stylesheet" type="text/css" href="css/anode.css">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-title" content="ANode">
    <script type="text/javascript" src="js/moment/moment.js"></script>
    <script type="text/javascript" src="js/anode.js"></script>
    <script type="text/javascript">
        window.onpageshow = function (event) {
            if (event.persisted) {
                window.location.reload()
            }
        };
        var datumsLast = [];
        var datumsTimer = {};
        var datumsLinks = {
            "all": "/",
            "temp": "/?metrics=temperature&metrics=conditions&bins=1day&bins=50s&bins=2s",
            "power": "/?metrics=power.consumption.grid&metrics=power.consumption.inverter&metrics=power.production.grid&metrics=power.production.inverter&metrics=power.utlisation.grid&metrics=power.utlisation.inverter&&metrics=power.utlisation.array",
            "energy": "/?metrics=energy&bins=1day"

        };
        var anode = new ANode(document.location.href,
            function () {
                var anodeMetric = "<a href=\"/?metrics=anode&metrics=_system\">anode" + "</a>";
                for (var datumsLinksName in datumsLinks) {
                    anodeMetric += (".<a href=\"" + datumsLinks[datumsLinksName] + "\">" + datumsLinksName + "</a>");
                }
                document.getElementById("datums_header_metric").innerHTML = anodeMetric;
                document.getElementById("datums_header_timeliness").innerHTML = "<a href=\"" + document.location.href + "\">connected</a>";
                styleTick(document.getElementById("datums_header_timeliness"), 1);
            },
            function () {
                document.getElementById("datums_header_timeliness").innerHTML = "<a href=\"" + document.location.href + "\">disconnected</a>";
                styleTick(document.getElementById("datums_header_timeliness"), -1);
            },
            function (datum) {
                if (document.location.href.indexOf("metrics=_system") > 0 || datum.data_metric.indexOf("anode") == -1) {
                    var datumDiv = document.getElementById(datum.ui_id);
                    if (datumDiv == null && datum.data_type !== "high" && datum.data_type !== "low") {
                        datumDiv = document.createElement("div");
                        datumDiv.id = datum.ui_id;
                        datumDiv.className = "datum";
                        var datumGroupsFields = {
                            "header": {
                                "metric": (function (metric) {
                                    var i;
                                    var metricLinks = "";
                                    var metricTokens = metric.split("\.");
                                    for (i = 0; i < metricTokens.length; i++) {
                                        metricLinks += (i == 0 ? "" : ".") + "<a href=\"/?metrics=" + metricTokens[i] +
                                            ((datum.data_metric.indexOf("anode") == 0) ? "&metrics=_system" : "") + "\">" + metricTokens[i] + "</a>"
                                    }
                                    return metricLinks
                                })(datum.data_metric),
                                "timeliness": datum.data_timeliness
                            },
                            "detail": {
                                "value": "",
                                "unit": (datum.data_unit == "scalor" || datum.data_type == "enumeration") ? null : datum.data_unit,
                                "trend": "",
                                "low": "",
                                "high": ""
                            }
                        };
                        for (var datumGroup in datumGroupsFields) {
                            var datumGroupDiv = document.createElement("div");
                            datumGroupDiv.className = "datum";
                            if (datumGroup == "detail") {
                                datumGroupDiv.appendChild(datumGroupDiv = document.createElement("a"));
                                datumGroupDiv.href = "/rest/?metrics=" + datum.data_metric + "&bins=" + datum.bin_width + datum.bin_unit + "&scope=history&format=csv"
                            }
                            for (var datumField in datumGroupsFields[datumGroup]) {
                                (function (datumField) {
                                    if (datumGroupsFields[datumGroup][datumField] != null) {
                                        var datumFieldSpan = document.createElement("span");
                                        datumFieldSpan.id = ((datumField == "low" || datumField == "high") ?
                                                (datum.ui_id_sans_bin + (datum.data_temporal == "forecast" || datum.data_type == "integral" ?
                                                    (datum.bin_width + "_" + datum.bin_unit) : "1_day")) : datum.ui_id) + "_" + datumField;
                                        datumFieldSpan.className = "datum-detail-" + datumField;
                                        datumFieldSpan.innerHTML = datumGroupsFields[datumGroup][datumField];
                                        datumGroupDiv.appendChild(datumFieldSpan);
                                    }
                                })(datumField);
                            }
                            datumDiv.appendChild(datumGroupDiv);
                        }
                        datumDiv.appendChild(document.createElement("hr"));
                        var index;
                        for (index = 0; index < datumsLast.length; index++) {
                            if (datumsLast[index].order_index > datum.order_index) {
                                break;
                            }
                        }
                        datumsLast.splice(index, 0, datum);
                        document.getElementById("datums").insertBefore(datumDiv, document.getElementById("datums").childNodes[index]);
                    }
                    var datumValueId = datum.ui_id + "_" + ((datum.data_type == "high" || datum.data_type == "low") ? datum.data_type : "value");
                    if (document.getElementById(datumValueId) != null) {
                        var datumValueDelta = datum.data_type == "enumeration" ? 0 : parseFloat(
                                document.getElementById(datumValueId).innerHTML.trim().length == 0 ? 0 :
                                    (datum.data_type == "high" ? 1 : (datum.data_type == "low" ? -1 :
                                            (datum.data_value / datum.data_scale - document.getElementById(datumValueId).innerHTML))).toFixed(2));
                        var datumGroupsValues = {
                            "value": {
                                "id": datumValueId,
                                "value": datum.data_type == "enumeration" ? datum.data_unit : (datum.data_type == "epoch" ?
                                        moment(new Date(datum.data_value * 1000)).format("HH:mm:ss").toLowerCase() : (datum.data_value / datum.data_scale)),
                                "value_delta": datumValueDelta,
                                "value_prefix": (datum.data_type == "high" ? "&#8613;" : (datum.data_type == "low" ? "&#8615;" : ""))
                            },
                            "unit": {
                                "id": datum.ui_id + "_unit",
                                "value": ((datum.data_type == "high" || datum.data_type == "low" || datum.data_type == "enumeration") ? null : datum.data_unit),
                                "value_delta": datumValueDelta,
                                "value_prefix": ""
                            },
                            "trend": {
                                "id": datum.ui_id + "_trend",
                                "value": ((datum.data_type == "high" || datum.data_type == "low") ? null : datum.data_type == "enumeration" ? datum.data_unit :
                                        (datum.data_type == "epoch" ? moment(new Date(datum.data_value * 1000)).format("MMM Do YYYY").toLowerCase() : datumValueDelta)),
                                "value_delta": datumValueDelta,
                                "value_prefix": datum.data_type == "epoch" ? "" : (datum.data_type == "enumeration" ? "was " : (datumValueDelta >= 0 ? "+" : ""))
                            }
                        };
                        for (var datumGroup in datumGroupsValues) {
                            (function (datumGroup) {
                                if (datumGroupsValues[datumGroup]["value"] !== null) {
                                    var datumDetailDiv = document.getElementById(datumGroupsValues[datumGroup]["id"]);
                                    if (datumDetailDiv !== null) {
                                        styleTick(datumDetailDiv, datumGroupsValues[datumGroup]["value_delta"]);
                                        datumDetailDiv.innerHTML = datumGroupsValues[datumGroup]["value_prefix"] + datumGroupsValues[datumGroup]["value"];
                                        if (datumGroupsValues[datumGroup]["id"] in datumsTimer) {
                                            window.clearTimeout(datumsTimer[datumGroupsValues[datumGroup]["id"]]);
                                        }
                                        datumsTimer[datumGroupsValues[datumGroup]["id"]] = window.setTimeout(function () {
                                            styleTick(datumDetailDiv, 0);
                                        }, 5000);
                                    }
                                }
                            })(datumGroup)
                        }
                    }
                }
            });
        function styleTick(element, delta) {
            element.classList.remove("datum-detail-up");
            element.classList.remove("datum-detail-down");
            if (delta > 0) {
                element.classList.add("datum-detail-up");
            }
            else if (delta < 0) {
                element.classList.add("datum-detail-down");
            }
        }
    </script>
</head>
<body>
<div>
    <div class="datums">
        <div class="datum">
            <div class="datum"><span id="datums_header_metric" class="datum-detail">anode</span><span
                    id="datums_header_timeliness" class="datum-detail"><a
                    href="javascript:window.location.href=window.location.href">connecting ...</a></span></div>
            <hr/>
        </div>
    </div>
    <div id="datums" class="datums"></div>
</div>
</body>
</html>